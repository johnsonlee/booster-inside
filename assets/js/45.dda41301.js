(window.webpackJsonp=window.webpackJsonp||[]).push([[45],{368:function(v,t,_){"use strict";_.r(t);var e=_(33),a=Object(e.a)({},(function(){var v=this,t=v.$createElement,_=v._self._c||t;return _("ContentSlotsDistributor",{attrs:{"slot-key":v.$parent.slotKey}},[_("h1",{attrs:{id:"class-文件格式"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#class-文件格式"}},[v._v("#")]),v._v(" class 文件格式")]),v._v(" "),_("p",[_("em",[v._v("class")]),v._v(" 文件的结构如下表所示：")]),v._v(" "),_("table",[_("thead",[_("tr",[_("th",[v._v("字节偏移量")]),v._v(" "),_("th",[v._v("字节数")]),v._v(" "),_("th",[v._v("类型／值")]),v._v(" "),_("th",[v._v("描述")])])]),v._v(" "),_("tbody",[_("tr",[_("td",[v._v("0")]),v._v(" "),_("td",[v._v("4")]),v._v(" "),_("td",[v._v("0xCAFEBABE")]),v._v(" "),_("td",[v._v("magic number")])]),v._v(" "),_("tr",[_("td",[v._v("4")]),v._v(" "),_("td",[v._v("2")]),v._v(" "),_("td",[v._v("unsigned 16-bit int")]),v._v(" "),_("td",[v._v("minor version")])]),v._v(" "),_("tr",[_("td",[v._v("6")]),v._v(" "),_("td",[v._v("2")]),v._v(" "),_("td",[v._v("unsigned 16-bit int")]),v._v(" "),_("td",[v._v("major version")])]),v._v(" "),_("tr",[_("td",[v._v("8")]),v._v(" "),_("td",[v._v("2 (cplen)")]),v._v(" "),_("td",[v._v("unsigned 16-bit int")]),v._v(" "),_("td",[v._v("常量数")])]),v._v(" "),_("tr",[_("td",[v._v("10")]),v._v(" "),_("td",[v._v("cpsize")]),v._v(" "),_("td",[v._v("list")]),v._v(" "),_("td",[v._v("常量池（索引从 "),_("em",[v._v("1")]),v._v(" 开始）")])]),v._v(" "),_("tr",[_("td",[v._v("10+cpsize")]),v._v(" "),_("td",[v._v("2")]),v._v(" "),_("td",[v._v("unsigned 16-bit int")]),v._v(" "),_("td",[v._v("access flags")])]),v._v(" "),_("tr",[_("td",[v._v("12+cpsize")]),v._v(" "),_("td",[v._v("2")]),v._v(" "),_("td",[v._v("unsigned 16-bit int")]),v._v(" "),_("td",[v._v("当前 "),_("em",[v._v("Class")]),v._v(" 在常量池中的索引")])]),v._v(" "),_("tr",[_("td",[v._v("14+cpsize")]),v._v(" "),_("td",[v._v("2")]),v._v(" "),_("td",[v._v("unsigned 16-bit int")]),v._v(" "),_("td",[v._v("父类 "),_("em",[v._v("Class")]),v._v(" 在常量池中的索引")])]),v._v(" "),_("tr",[_("td",[v._v("16+cpsize")]),v._v(" "),_("td",[v._v("2 (ilen)")]),v._v(" "),_("td",[v._v("unsigned 16-bit int")]),v._v(" "),_("td",[v._v("当前 "),_("em",[v._v("Class")]),v._v(" 实现的接口数")])]),v._v(" "),_("tr",[_("td",[v._v("18+cpsize")]),v._v(" "),_("td",[v._v("ilen * 2")]),v._v(" "),_("td",[v._v("unsigned 16-bit int[]")]),v._v(" "),_("td",[v._v("当前 "),_("em",[v._v("Class")]),v._v(" 实现的接口在常量池中的索引")])]),v._v(" "),_("tr",[_("td",[v._v("18+cpsize+isize")]),v._v(" "),_("td",[v._v("2")]),v._v(" "),_("td",[v._v("unsigned 16-bit int")]),v._v(" "),_("td",[v._v("字段数")])]),v._v(" "),_("tr",[_("td",[v._v("20+cpsize+isize")]),v._v(" "),_("td",[v._v("fsize")]),v._v(" "),_("td",[v._v("list")]),v._v(" "),_("td",[v._v("字段列表")])]),v._v(" "),_("tr",[_("td",[v._v("20+cpsize+isize+fsize")]),v._v(" "),_("td",[v._v("2")]),v._v(" "),_("td",[v._v("unsigned 16-bit int")]),v._v(" "),_("td",[v._v("方法数")])]),v._v(" "),_("tr",[_("td",[v._v("22+cpsize+isize+fsize")]),v._v(" "),_("td",[v._v("msize")]),v._v(" "),_("td",[v._v("list")]),v._v(" "),_("td",[v._v("方法列表")])]),v._v(" "),_("tr",[_("td",[v._v("22+cpsize+isize+fsize+msize")]),v._v(" "),_("td",[v._v("2")]),v._v(" "),_("td",[v._v("unsigned 16-bit int")]),v._v(" "),_("td",[v._v("属性数")])]),v._v(" "),_("tr",[_("td",[v._v("24+cpsize+isize+fsize+msize")]),v._v(" "),_("td",[v._v("asize")]),v._v(" "),_("td",[v._v("list")]),v._v(" "),_("td",[v._v("属性列表")])])])]),v._v(" "),_("blockquote",[_("p",[v._v("更详细的 "),_("em",[v._v("class")]),v._v(" 文件格式，请参考："),_("a",{attrs:{href:"https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.1",target:"_blank",rel:"noopener noreferrer"}},[v._v("Java Virtual Machine Specification: Chapter 4. The "),_("em",[v._v("class")]),v._v(" File Format"),_("OutboundLink")],1),v._v("。")])]),v._v(" "),_("h2",{attrs:{id:"class-版本"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#class-版本"}},[v._v("#")]),v._v(" "),_("em",[v._v("class")]),v._v(" 版本")]),v._v(" "),_("p",[v._v("作为 "),_("em",[v._v("Android")]),v._v(" 或者 "),_("em",[v._v("Java")]),v._v(" 开发者，大多都只关心 "),_("em",[v._v("javac")]),v._v(" 的版本号，为什么 "),_("em",[v._v("class")]),v._v(" 文件也有版本号呢？—— 是给 JRE 看的，举两个例子：")]),v._v(" "),_("ol",[_("li",[_("em",[v._v("Java 7")]),v._v(" 执行用带有 "),_("em",[v._v("Java 8")]),v._v(" 编译的带 "),_("em",[v._v("lambda")]),v._v(" 的 "),_("em",[v._v("class")])]),v._v(" "),_("li",[_("em",[v._v("Java 7")]),v._v(" 执行用 "),_("em",[v._v("Java 8")]),v._v(" 编译的不带 "),_("em",[v._v("Java 8")]),v._v(" 新特性的 "),_("em",[v._v("class")])])]),v._v(" "),_("p",[v._v("正常情况下，以上两种情况都不会执行成功，为什么？因为 "),_("em",[v._v("Java 7")]),v._v(" 不支持 "),_("em",[v._v("Java 8")]),v._v(" 编译的 "),_("em",[v._v("class")]),v._v(" ，可是有人会问：第 2 种情况下，我并没有用到 "),_("em",[v._v("Java 8")]),v._v(" 的新特性，为什么 "),_("em",[v._v("Java 7")]),v._v(" 就不能执行呢？—— 因为 "),_("em",[v._v("major version")]),v._v(" 的原因，低版本的 JRE 是不支持运行高版本的 "),_("em",[v._v("class")]),v._v(" 的。")]),v._v(" "),_("p",[v._v("如何让第 2 种情况也能正常运行呢？—— 在用 "),_("em",[v._v("Java 8")]),v._v(" 编译时指定 "),_("em",[v._v("-target 1.7")]),v._v(" 或者更低即可，在 "),_("em",[v._v("Gradle")]),v._v(" 中则是：")]),v._v(" "),_("div",{staticClass:"language-groovy extra-class"},[_("pre",{pre:!0,attrs:{class:"language-groovy"}},[_("code",[v._v("java "),_("span",{pre:!0,attrs:{class:"token punctuation"}},[v._v("{")]),v._v("\n    targetCompatibility "),_("span",{pre:!0,attrs:{class:"token operator"}},[v._v("=")]),v._v(" JavaVersion"),_("span",{pre:!0,attrs:{class:"token punctuation"}},[v._v(".")]),v._v("VERSION_1_7\n"),_("span",{pre:!0,attrs:{class:"token punctuation"}},[v._v("}")]),v._v("\n")])])]),_("p",[_("em",[v._v("Java")]),v._v(" 各版本的 "),_("em",[v._v("major version")]),v._v(" 如下表所示：")]),v._v(" "),_("table",[_("thead",[_("tr",[_("th",[v._v("Java Version")]),v._v(" "),_("th",{staticStyle:{"text-align":"center"}},[v._v("major version")])])]),v._v(" "),_("tbody",[_("tr",[_("td",[v._v("Java SE 14")]),v._v(" "),_("td",{staticStyle:{"text-align":"center"}},[v._v("58")])]),v._v(" "),_("tr",[_("td",[v._v("Java SE 13")]),v._v(" "),_("td",{staticStyle:{"text-align":"center"}},[v._v("57")])]),v._v(" "),_("tr",[_("td",[v._v("Java SE 12")]),v._v(" "),_("td",{staticStyle:{"text-align":"center"}},[v._v("56")])]),v._v(" "),_("tr",[_("td",[v._v("Java SE 11")]),v._v(" "),_("td",{staticStyle:{"text-align":"center"}},[v._v("55")])]),v._v(" "),_("tr",[_("td",[v._v("Java SE 10")]),v._v(" "),_("td",{staticStyle:{"text-align":"center"}},[v._v("54")])]),v._v(" "),_("tr",[_("td",[v._v("Java SE 9")]),v._v(" "),_("td",{staticStyle:{"text-align":"center"}},[v._v("53")])]),v._v(" "),_("tr",[_("td",[v._v("Java SE 8")]),v._v(" "),_("td",{staticStyle:{"text-align":"center"}},[v._v("52")])]),v._v(" "),_("tr",[_("td",[v._v("Java SE 7")]),v._v(" "),_("td",{staticStyle:{"text-align":"center"}},[v._v("51")])]),v._v(" "),_("tr",[_("td",[v._v("Java SE 6")]),v._v(" "),_("td",{staticStyle:{"text-align":"center"}},[v._v("50")])]),v._v(" "),_("tr",[_("td",[v._v("Java SE 5")]),v._v(" "),_("td",{staticStyle:{"text-align":"center"}},[v._v("49")])]),v._v(" "),_("tr",[_("td",[v._v("JDK 1.4")]),v._v(" "),_("td",{staticStyle:{"text-align":"center"}},[v._v("48")])]),v._v(" "),_("tr",[_("td",[v._v("JDK 1.3")]),v._v(" "),_("td",{staticStyle:{"text-align":"center"}},[v._v("47")])]),v._v(" "),_("tr",[_("td",[v._v("JDK 1.2")]),v._v(" "),_("td",{staticStyle:{"text-align":"center"}},[v._v("46")])]),v._v(" "),_("tr",[_("td",[v._v("JDK 1.1")]),v._v(" "),_("td",{staticStyle:{"text-align":"center"}},[v._v("45")])])])]),v._v(" "),_("h2",{attrs:{id:"常量池"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#常量池"}},[v._v("#")]),v._v(" 常量池")]),v._v(" "),_("p",[v._v("每个 "),_("em",[v._v("class")]),v._v(" 文件中都有一个常量池，除了 "),_("em",[v._v("Integer")]),v._v(" ，"),_("em",[v._v("Float")]),v._v(" ，"),_("em",[v._v("Long")]),v._v(" ，"),_("em",[v._v("Double")]),v._v(" ，"),_("em",[v._v("String")]),v._v(" 以外，还有 "),_("em",[v._v("Class")]),v._v(" ，"),_("em",[v._v("Field")]),v._v(" 引用，"),_("em",[v._v("Method")]),v._v(" 引用等等，所以，常量池占了整个 "),_("em",[v._v("class")]),v._v(" 文件很大一部分空间，这也是为什么 "),_("em",[v._v("Android")]),v._v(" 采用 "),_("em",[v._v("dex")]),v._v(" 这种格式，来解决常量池带来空间浪费，当然，这只是其中原因之一。")]),v._v(" "),_("h2",{attrs:{id:"属性"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#属性"}},[v._v("#")]),v._v(" 属性")]),v._v(" "),_("p",[v._v("从 "),_("em",[v._v("class")]),v._v(" 文件的结构，我们可以看出，无论是 "),_("em",[v._v("class")]),v._v(" 还是 "),_("em",[v._v("field")]),v._v(" ，抑或是 "),_("em",[v._v("method")]),v._v(" ，"),_("em",[v._v("attribute")]),v._v(" 都是位于其结构的最末尾，为什么没放在前面的位置呢？主要是因为 JVM 规范支持编译器定义自己特有的 "),_("em",[v._v("attribute")]),v._v(" 的（例如："),_("a",{attrs:{href:"https://github.com/Sable/soot",target:"_blank",rel:"noopener noreferrer"}},[v._v("Soot"),_("OutboundLink")],1),v._v(" 就支持"),_("a",{attrs:{href:"https://git.io/JvbwO",target:"_blank",rel:"noopener noreferrer"}},[v._v("给 "),_("em",[v._v("class")]),v._v(" 文件新增 "),_("em",[v._v("attribute")]),_("OutboundLink")],1),v._v("） ，正是 "),_("em",[v._v("attribute")]),v._v(" 的可扩展性，这也使得 "),_("em",[v._v("attribute")]),v._v(" 成为 "),_("em",[v._v("class")]),v._v(" 文件结构中最复杂的部分。")]),v._v(" "),_("p",[v._v("在 JVM 规范定义的 23 种 "),_("em",[v._v("attribute")]),v._v(" 中，以下 6 种对于 JVM 来说是可选的：")]),v._v(" "),_("ul",[_("li",[_("em",[v._v("SourceFile")])]),v._v(" "),_("li",[_("em",[v._v("SourceDebugExtension")])]),v._v(" "),_("li",[_("em",[v._v("LineNumberTable")])]),v._v(" "),_("li",[_("em",[v._v("LocalVariableTable")])]),v._v(" "),_("li",[_("em",[v._v("LocalVariableTypeTable")])]),v._v(" "),_("li",[_("em",[v._v("Deprecated")])])]),v._v(" "),_("p",[v._v("所以，这给优化应用 size 的开发者提供了一个思路。")])])}),[],!1,null,null,null);t.default=a.exports}}]);