(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{360:function(t,a,e){"use strict";e.r(a);var s=e(33),r=Object(s.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"aapt2-产物逆向"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#aapt2-产物逆向"}},[t._v("#")]),t._v(" AAPT2 产物逆向")]),t._v(" "),e("h2",{attrs:{id:"为什么要逆向-aapt2-产物"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#为什么要逆向-aapt2-产物"}},[t._v("#")]),t._v(" 为什么要逆向 "),e("em",[t._v("AAPT2")]),t._v(" 产物")]),t._v(" "),e("p",[t._v("根据上一章我们对 "),e("em",[t._v("Android")]),t._v(" 工程的构建流程的了解，如果要处理 "),e("em",[t._v("APP")]),t._v(" 中的资源，一般会选择从 "),e("em",[t._v("processRes")]),t._v(" 任务的产出物中获取，而从 "),e("em",[t._v("Android Gradle Plugin 3.0.0")]),t._v(" 开始，"),e("em",[t._v("processRes")]),t._v(" 任务的产出物已经不再是原始的资源文件了，而是由特定的格式（"),e("em",[t._v("AAPT2")]),t._v("）所编码的二进制。")]),t._v(" "),e("p",[t._v("在 "),e("em",[t._v("Booster")]),t._v(" 的优化特性中，有很多特性的来实现都依赖于解析这些被 "),e("em",[t._v("AAPT2")]),t._v(" 编译过的二进制资源，例如：")]),t._v(" "),e("ol",[e("li",[e("a",{attrs:{href:"https://github.com/didi/booster/tree/master/booster-task-analyser",target:"_blank",rel:"noopener noreferrer"}},[t._v("booster-task-analyser"),e("OutboundLink")],1),t._v(" 以布局文件中的自定义 "),e("em",[t._v("View")]),t._v(" 作为静态分析的入口来构建 "),e("em",[t._v("Call Graph")]),t._v("；")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://github.com/didi/booster/tree/master/booster-transform-r-inline",target:"_blank",rel:"noopener noreferrer"}},[t._v("booster-transform-r-inline"),e("OutboundLink")],1),t._v(" 从布局文件中提取 "),e("em",[t._v("ConstraintLayout")]),t._v(" 引用的资源 "),e("em",[t._v("ID")]),t._v("；")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://github.com/didi/booster/tree/master/booster-task-compression-pngquant",target:"_blank",rel:"noopener noreferrer"}},[t._v("booster-task-compression-pngquant"),e("OutboundLink")],1),t._v(" 和 "),e("a",{attrs:{href:"https://github.com/didi/booster/tree/master/booster-task-compression-cwebp",target:"_blank",rel:"noopener noreferrer"}},[t._v("booster-task-compression-cwebp"),e("OutboundLink")],1),t._v(" 从 "),e("em",[t._v("*.png.flat")]),t._v(" 文件中获取图片资源名称及其源文件路径；")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://github.com/didi/booster/tree/master/booster-task-resource-deredundancy",target:"_blank",rel:"noopener noreferrer"}},[t._v("booster-task-resource-deredundancy"),e("OutboundLink")],1),t._v(" 从 "),e("em",[t._v("*.png.flat")]),t._v(" 文件中获取图片资源的 "),e("em",[t._v("Configuration")]),t._v("；")])]),t._v(" "),e("h2",{attrs:{id:"什么是-aapt2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#什么是-aapt2"}},[t._v("#")]),t._v(" 什么是 AAPT2 ?")]),t._v(" "),e("p",[e("em",[t._v("AAPT2")]),t._v("（"),e("em",[t._v("Android")]),t._v(" 资源打包工具）是一个构建工具，"),e("em",[t._v("Android Studio")]),t._v(" 和 "),e("em",[t._v("Android Gradle Plugin")]),t._v(" 使用它来编译和打包应用的资源。"),e("em",[t._v("AAPT2")]),t._v(" 会解析资源、为资源编制索引，并将资源编译为针对 Android 平台进行过优化的二进制格式。")]),t._v(" "),e("p",[e("em",[t._v("AAPT2")]),t._v(" 的可执行文件随 "),e("em",[t._v("Android SDK")]),t._v(" 的 "),e("em",[t._v("Build Tools")]),t._v(" 一起发布，以 "),e("em",[t._v("Build Tools 29.0.0")]),t._v(" 为例，"),e("em",[t._v("aapt2")]),t._v(" 可执行文件位于：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("$ANDROID_HOME/build-tools/29.0.0/aapt2\n")])])]),e("p",[t._v("从 "),e("em",[t._v("Android Gradle Plugin 3.0.0")]),t._v(" 开始，"),e("em",[t._v("AAPT2")]),t._v(" 默认开启，相对于 "),e("em",[t._v("AAPT")]),t._v("，资源打包流程由原来的单一编译过程拆分为「编译」和「链接」两个阶段。")]),t._v(" "),e("h3",{attrs:{id:"编译阶段"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#编译阶段"}},[t._v("#")]),t._v(" 编译阶段")]),t._v(" "),e("p",[e("em",[t._v("Android")]),t._v(" 所有类型的资源的编译都是通过 "),e("em",[t._v("AAPT2")]),t._v(" 来完成，资源的编译使用 "),e("em",[t._v("compile")]),t._v(" 子命令，编译成功后，会生成一个扩展名为 "),e("em",[t._v(".flat")]),t._v(" 的中间二进制文件，正常情况下，每一个输入的资源文件对应输出一个 "),e("em",[t._v(".flat")]),t._v(" 文件，然后在后续的链接阶段使用。")]),t._v(" "),e("h4",{attrs:{id:"编译单个资源"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#编译单个资源"}},[t._v("#")]),t._v(" 编译单个资源")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ aapt2 compile -o build ./app/src/main/res/mipmap-xxxhdpi/ic_launcher.png\n")])])]),e("h4",{attrs:{id:"编译多个资源"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#编译多个资源"}},[t._v("#")]),t._v(" 编译多个资源")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ aapt2 compile -o build "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    ./app/src/main/res/mipmap-xxxhdpi/ic_launcher.png "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    ./app/src/main/res/layout/activity_main.xml "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    ./app/src/main/res/values/strings.xml\n")])])]),e("h4",{attrs:{id:"编译整个目录"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#编译整个目录"}},[t._v("#")]),t._v(" 编译整个目录")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ aapt2 compile -o build/resources.ap_  --dir ./app/src/main/res/\n")])])]),e("p",[t._v("通过 "),e("em",[t._v("unzip")]),t._v(" 命令查看 "),e("em",[t._v("build/resources.ap_")]),t._v(" 文件内容：")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("unzip")]),t._v(" -lv build/resources.ap_\n")])])]),e("p",[t._v("结果如下：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("Archive:  build/resources.ap_\n Length   Method    Size  Cmpr    Date    Time   CRC-32   Name\n--------  ------  ------- ---- ---------- ----- --------  ----\n    2964  Stored     2964   0% 01-01-1980 08:00 222c02e4  drawable-v24_ic_launcher_foreground.xml.flat\n   10400  Stored    10400   0% 01-01-1980 08:00 c51d04d8  drawable_ic_launcher_background.xml.flat\n    1004  Stored     1004   0% 01-01-1980 08:00 b7942223  layout_activity_main.xml.flat\n     468  Stored      468   0% 01-01-1980 08:00 719ae087  mipmap-anydpi-v26_ic_launcher.xml.flat\n     480  Stored      480   0% 01-01-1980 08:00 51d410e6  mipmap-anydpi-v26_ic_launcher_round.xml.flat\n    3076  Stored     3076   0% 01-01-1980 08:00 b7c61139  mipmap-hdpi_ic_launcher.png.flat\n    5032  Stored     5032   0% 01-01-1980 08:00 4e0c4c11  mipmap-hdpi_ic_launcher_round.png.flat\n    2172  Stored     2172   0% 01-01-1980 08:00 8403a200  mipmap-mdpi_ic_launcher.png.flat\n    2908  Stored     2908   0% 01-01-1980 08:00 fa7067cb  mipmap-mdpi_ic_launcher_round.png.flat\n    4604  Stored     4604   0% 01-01-1980 08:00 7d50d1c1  mipmap-xhdpi_ic_launcher.png.flat\n    7020  Stored     7020   0% 01-01-1980 08:00 b81236dd  mipmap-xhdpi_ic_launcher_round.png.flat\n    6504  Stored     6504   0% 01-01-1980 08:00 087eaa8c  mipmap-xxhdpi_ic_launcher.png.flat\n   10544  Stored    10544   0% 01-01-1980 08:00 a3248946  mipmap-xxhdpi_ic_launcher_round.png.flat\n    9056  Stored     9056   0% 01-01-1980 08:00 da999b7f  mipmap-xxxhdpi_ic_launcher.png.flat\n   15260  Stored    15260   0% 01-01-1980 08:00 3c9e8eea  mipmap-xxxhdpi_ic_launcher_round.png.flat\n     296  Stored      296   0% 01-01-1980 08:00 eeebffe4  values-v13_styles.arsc.flat\n     296  Stored      296   0% 01-01-1980 08:00 08cc005e  values-v21_styles.arsc.flat\n     332  Stored      332   0% 01-01-1980 08:00 3050ad73  values_colors.arsc.flat\n     248  Stored      248   0% 01-01-1980 08:00 b5f978d1  values_strings.arsc.flat\n     284  Stored      284   0% 01-01-1980 08:00 b1096c78  values_styles.arsc.flat\n--------          -------  ---                            -------\n   82948            82948   0%                            20 files\n")])])]),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),e("p",[t._v("注意：对于资源文件，输入文件的路径必须符合以下结构：path/"),e("code",[t._v("resource-type")]),t._v("[-"),e("code",[t._v("configuration")]),t._v("]/file，否则，会报如下错误：")]),t._v(" "),e("p",[e("em",[t._v("error: invalid file path '...'")])])]),t._v(" "),e("h3",{attrs:{id:"链接阶段"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#链接阶段"}},[t._v("#")]),t._v(" 链接阶段")]),t._v(" "),e("p",[t._v("在链接阶段，"),e("em",[t._v("AAPT2")]),t._v(" 会合并在编译阶段生成的所有中间文件（"),e("em",[t._v(".flat")]),t._v(" 文件），并将它们打包成 "),e("em",[t._v("ZIP")]),t._v(" 包（最终 "),e("em",[t._v("APK")]),t._v(" 的原型，由于不包括 "),e("em",[t._v("DEX")]),t._v(" 文件且未签名，所以无法正常安装）。")]),t._v(" "),e("p",[t._v("链接资源使用 "),e("em",[t._v("link")]),t._v(" 子命令，如下所示：")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ aapt2 "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("link")]),t._v(" -o build/resources.ap_ "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    -I "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$ANDROID_HOME")]),t._v("/platforms/android-29/android.jar "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    --manifest build/intermediates/manifests/full/debug/AndroidManifest.xml "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    build/layout_activity_main.xml.flat "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    build/values_styles.arsc.flat "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    build/values_colors.arsc.flat "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    build/values_strings.arsc.flat "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    build/mipmap-xxxhdpi_ic_launcher.png.flat "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    build/mipmap-xxxhdpi_ic_launcher_round.png.flat\n")])])]),e("h2",{attrs:{id:"aapt2-容器格式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#aapt2-容器格式"}},[t._v("#")]),t._v(" AAPT2 容器格式")]),t._v(" "),e("p",[t._v("在 "),e("em",[t._v("AAPT2")]),t._v(" 的编译阶段，会生成扩展名为 "),e("em",[t._v(".flat")]),t._v(" 的中间二进制文件，这种以 "),e("em",[t._v(".flat")]),t._v(" 作为扩展名的文件格式，被称之为 "),e("em",[t._v("AAPT2")]),t._v(" 容器，"),e("em",[t._v("AAPT2")]),t._v(" 容器文件由文件头和资源项两大部分组成，容器中的各个字段以小端（"),e("em",[t._v("Little-Endian")]),t._v("）字节序表示：")]),t._v(" "),e("h3",{attrs:{id:"aapt2-文件头"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#aapt2-文件头"}},[t._v("#")]),t._v(" AAPT2 文件头")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("字段")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("字节数")]),t._v(" "),e("th",[t._v("描述")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[e("code",[t._v("magic")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("4")]),t._v(" "),e("td",[e("em",[t._v("AAPT2")]),t._v(" 容器文件标识："),e("code",[t._v("AAPT")]),t._v(" 或 "),e("code",[t._v("0x54504141")])])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("version")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("4")]),t._v(" "),e("td",[e("em",[t._v("AAPT2")]),t._v(" 容器版本")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("entry_count")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("4")]),t._v(" "),e("td",[t._v("容器中包含的条目数（一个 "),e("em",[t._v("flat")]),t._v(" 文件中可以包含多个资源项）")])])])]),t._v(" "),e("h3",{attrs:{id:"aapt2-资源项"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#aapt2-资源项"}},[t._v("#")]),t._v(" AAPT2 资源项")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("字段")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("字节数")]),t._v(" "),e("th",[t._v("描述")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[e("code",[t._v("entry_type")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("4")]),t._v(" "),e("td",[t._v("资源类型（目前仅支持两种类型："),e("code",[t._v("RES_TABLE(0x00000000)")]),t._v(" 或 "),e("code",[t._v("RES_FILE (0x00000001)")]),t._v("）")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("entry_length")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("8")]),t._v(" "),e("td",[t._v("资源数据长度")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("data")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("entry_length")])]),t._v(" "),e("td",[t._v("资源数据")])])])]),t._v(" "),e("h4",{attrs:{id:"resource-table"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#resource-table"}},[t._v("#")]),t._v(" Resource Table")]),t._v(" "),e("p",[t._v("当 "),e("code",[t._v("entry_type")]),t._v("为 "),e("code",[t._v("0x00000000")]),t._v(" 时，"),e("code",[t._v("data")]),t._v(" 表示 "),e("em",[t._v("protobuf")]),t._v(" 序列化的 "),e("a",{attrs:{href:"https://github.com/aosp-mirror/platform_frameworks_base/blob/master/tools/aapt2/Resources.proto",target:"_blank",rel:"noopener noreferrer"}},[t._v("ResourceTable"),e("OutboundLink")],1),t._v(" 结构")]),t._v(" "),e("h4",{attrs:{id:"resource-file"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#resource-file"}},[t._v("#")]),t._v(" Resource File")]),t._v(" "),e("p",[t._v("当 "),e("code",[t._v("entry_type")]),t._v("为 "),e("code",[t._v("0x00000001")]),t._v(" 时，"),e("code",[t._v("data")]),t._v(" 表示资源文件，格式如下：")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("字段")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("字节数")]),t._v(" "),e("th",[t._v("描述")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[e("code",[t._v("header_size")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("4")]),t._v(" "),e("td",[e("code",[t._v("header")]),t._v(" 的长度")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("data_size")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("8")]),t._v(" "),e("td",[e("code",[t._v("data")]),t._v(" 的长度")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("header")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("header_size")])]),t._v(" "),e("td",[t._v("表示 "),e("em",[t._v("protobuf")]),t._v(" 序列化的 "),e("a",{attrs:{href:"https://github.com/aosp-mirror/platform_frameworks_base/blob/master/tools/aapt2/ResourcesInternal.proto",target:"_blank",rel:"noopener noreferrer"}},[t._v("CompiledFile"),e("OutboundLink")],1),t._v(" 结构")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("header_padding")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("x")])]),t._v(" "),e("td",[e("em",[t._v("0-3")]),t._v(" 个填充字节，用于 "),e("code",[t._v("data")]),t._v(" 32 位对齐")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("data")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("data_size")])]),t._v(" "),e("td",[t._v("资源文件内容（"),e("em",[t._v("PNG")]),t._v(", 二进制 "),e("em",[t._v("XML")]),t._v(" 或者 "),e("em",[t._v("protobuf")]),t._v(" 序列化的 "),e("a",{attrs:{href:"https://github.com/aosp-mirror/platform_frameworks_base/blob/master/tools/aapt2/Resources.proto",target:"_blank",rel:"noopener noreferrer"}},[t._v("XmlNode"),e("OutboundLink")],1),t._v(" 结构）")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("data_padding")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("y")])]),t._v(" "),e("td",[e("em",[t._v("0-3")]),t._v(" 个填充字节，用于 "),e("code",[t._v("data")]),t._v(" 32 位对齐")])])])]),t._v(" "),e("blockquote",[e("p",[t._v("AAPT2 格式规范：https://github.com/aosp-mirror/platform_frameworks_base/blob/master/tools/aapt2/formats.md")])]),t._v(" "),e("h3",{attrs:{id:"flat-格式的兼容性问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#flat-格式的兼容性问题"}},[t._v("#")]),t._v(" "),e("em",[t._v("flat")]),t._v(" 格式的兼容性问题")]),t._v(" "),e("p",[t._v("虽然 "),e("em",[t._v("Android Gradle Plugin 3.0.0")]),t._v(" 已经默认启用 "),e("em",[t._v("AAPT2")]),t._v("，但是 "),e("em",[t._v("AAPT2")]),t._v(" 的产出物（"),e("em",[t._v("flat")]),t._v(" 文件）的格式直到 "),e("em",[t._v("Android Gradle Plugin 3.2.0")]),t._v(" 才稳定下来，那 "),e("em",[t._v("3.2.0")]),t._v(" 以前的版本产出的 "),e("em",[t._v("flat")]),t._v(" 文件格式到底是什么样子呢？")]),t._v(" "),e("h4",{attrs:{id:"resource-file-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#resource-file-2"}},[t._v("#")]),t._v(" Resource File")]),t._v(" "),e("p",[t._v("通过逆向分析 "),e("em",[t._v("flat")]),t._v(" 文件，我们还原了 "),e("em",[t._v("Android Gradle Plugin 3.2.0")]),t._v(" 以前的版本产出的 "),e("em",[t._v("flat")]),t._v(" 文件格式，如下表所示：")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("字段")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("字节数")]),t._v(" "),e("th",[t._v("描述")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[e("code",[t._v("entry_type")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("4")]),t._v(" "),e("td",[t._v("资源类型（通常为："),e("code",[t._v("RES_FILE (0x00000001)")]),t._v("）")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("entry_length")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("8")]),t._v(" "),e("td",[t._v("资源数据长度")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("header")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("header_size")])]),t._v(" "),e("td",[t._v("表示 "),e("em",[t._v("protobuf")]),t._v(" 序列化的 "),e("a",{attrs:{href:"https://github.com/didi/booster/blob/master/booster-aapt2/src/main/proto/ResourcesInternalLegacy.proto#L20",target:"_blank",rel:"noopener noreferrer"}},[t._v("CompiledFile"),e("OutboundLink")],1)])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("header_padding")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("x")])]),t._v(" "),e("td",[e("em",[t._v("0-3")]),t._v(" 个填充字节，用于 "),e("code",[t._v("data")]),t._v(" 32 位对齐")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("data")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("entry_length")])]),t._v(" "),e("td",[t._v("资源数据")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("data_padding")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("y")])]),t._v(" "),e("td",[e("em",[t._v("0-3")]),t._v(" 个填充字节，用于 "),e("code",[t._v("data")]),t._v(" 32 位对齐")])])])]),t._v(" "),e("h4",{attrs:{id:"resource-table-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#resource-table-2"}},[t._v("#")]),t._v(" Resource Table")]),t._v(" "),e("p",[e("em",[t._v("Resource Table")]),t._v(" 的格式比较简单，其实就是 "),e("a",{attrs:{href:"https://github.com/aosp-mirror/platform_frameworks_base/blob/0c80895c203640148da94bf04a57f1965a1c0d3d/tools/aapt2/Format.proto#L69",target:"_blank",rel:"noopener noreferrer"}},[t._v("ResourceTable"),e("OutboundLink")],1),t._v(" 的 "),e("em",[t._v("protobuf")]),t._v(" 序列化结果。")]),t._v(" "),e("blockquote",[e("p",[t._v("关于二进制文件的逆向工具，类 "),e("em",[t._v("Linux")]),t._v(" 系统都自带 "),e("em",[t._v("xxd")]),t._v(" 命令，可以直接输出二进制文件的十六进制格式：")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ xxd ./build/intermediates/res/merged/debug/mipmap-hdpi_ic_launcher.png.flat\n")])])]),e("p",[t._v("或者使用 "),e("em",[t._v("VIM")]),t._v(" 打开二进制文件")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" ./build/intermediates/res/merged/debug/mipmap-hdpi_ic_launcher.png.flat\n")])])]),e("p",[t._v("然后在 "),e("em",[t._v("VIM")]),t._v(" 中输入：")]),t._v(" "),e("div",{staticClass:"language-vim extra-class"},[e("pre",{pre:!0,attrs:{class:"language-vim"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("xxd\n")])])])]),t._v(" "),e("h2",{attrs:{id:"flat-与-aapt-产物的关系"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#flat-与-aapt-产物的关系"}},[t._v("#")]),t._v(" "),e("em",[t._v("flat")]),t._v(" 与 "),e("em",[t._v("AAPT")]),t._v(" 产物的关系")]),t._v(" "),e("p",[t._v("在 "),e("em",[t._v("Android Gradle Plugin 3.0")]),t._v(" 以前的版本中，"),e("em",[t._v("AAPT")]),t._v(" 的产物主要有 "),e("em",[t._v("3")]),t._v(" 类：")]),t._v(" "),e("ol",[e("li",[t._v("已编译的二进制 XML，例如：布局 "),e("em",[t._v("XML")]),t._v(" 文件；")]),t._v(" "),e("li",[t._v("字符串池（"),e("em",[t._v("String Pool")]),t._v("），内嵌于 "),e("em",[t._v("Resource Table")]),t._v(" 中，一般不会独立存在；")]),t._v(" "),e("li",[t._v("资源表（"),e("em",[t._v("Resource Table")]),t._v("），例如："),e("em",[t._v("ARSC")]),t._v(" 文件；")])]),t._v(" "),e("p",[e("em",[t._v("AAPT2")]),t._v(" 的大部分数据结构都采用 "),e("em",[t._v("protobuf")]),t._v(" 重新进行编码，但还有一小部分数据结构仍然复用了"),e("em",[t._v("AAPT")]),t._v(" 的格式，例如："),e("em",[t._v("String Pool")]),t._v(" ，我们从 "),e("em",[t._v("AAPT2")]),t._v(" 的 "),e("em",[t._v("proto")]),t._v(" 定义便可以看出来：")]),t._v(" "),e("div",{staticClass:"language-protobuf extra-class"},[e("pre",{pre:!0,attrs:{class:"language-protobuf"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("message")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StringPool")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bytes")]),t._v(" data "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("message")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ResourceTable")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The string pool containing source paths referenced throughout the resource table. This does")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// not end up in the final binary ARSC file.")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token positional-class-name class-name"}},[t._v("StringPool")]),t._v(" source_pool "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Resource definitions corresponding to an Android package.")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("repeated")]),t._v(" Package "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h2",{attrs:{id:"aapt2-容器的意义"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#aapt2-容器的意义"}},[t._v("#")]),t._v(" "),e("em",[t._v("AAPT2")]),t._v(" 容器的意义")]),t._v(" "),e("p",[e("em",[t._v("AAPT2")]),t._v(" 为什么要将中间产物编码成 "),e("em",[t._v("flat")]),t._v(" 格式呢？主要原因在于 "),e("em",[t._v("AAPT2")]),t._v(" 将资源打包过程拆分成了两个阶段：「编译阶段」和「链接阶段」，为了在链接阶段得到资源更详细的信息，例如：资源名称、配置信息（"),e("em",[t._v("Configuration")]),t._v("） 等，因此，直接将资源的元信息连同资源本身一同编码进 "),e("em",[t._v("AAPT2")]),t._v(" 容器文件中，这样，资源链接的过程可以完全与编译过程解耦了，而且，对于增量构建来说，这样大大提升了资源打包的性能。")]),t._v(" "),e("h2",{attrs:{id:"在-gradle-插件中访问-aapt2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#在-gradle-插件中访问-aapt2"}},[t._v("#")]),t._v(" 在 "),e("em",[t._v("Gradle")]),t._v(" 插件中访问 "),e("em",[t._v("aapt2")])]),t._v(" "),e("h3",{attrs:{id:"agp-3-5-0-以下版本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#agp-3-5-0-以下版本"}},[t._v("#")]),t._v(" "),e("em",[t._v("AGP 3.5.0")]),t._v(" 以下版本")]),t._v(" "),e("div",{staticClass:"language-kotlin extra-class"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("findAapt2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("project"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Project"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    project"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("applicationVariants"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" variant "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" variantImpl "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" variant "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" ApplicationVariantImpl"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" buildTool "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" variantImpl"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("variantData"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scope"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("globalScope"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("androidBuilder"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("buildToolInfo"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" aapt2 "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" buildTool"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPath")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BuildToolInfo"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("PathId"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AAPT2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// do something with aapt2")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h3",{attrs:{id:"agp-3-5-0-以上版本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#agp-3-5-0-以上版本"}},[t._v("#")]),t._v(" "),e("em",[t._v("AGP 3.5.0")]),t._v(" 以上版本")]),t._v(" "),e("div",{staticClass:"language-kotlin extra-class"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("findAapt2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("project"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Project"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    project"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("applicationVariants"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" variant "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" variantImpl "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" variant "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" ApplicationVariantImpl"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" buildTool "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" variantImpl"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("variantData"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scope"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("globalScope"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("androidBuilder"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("buildToolInfoProvider"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" aapt2 "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" buildTool"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPath")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BuildToolInfo"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("PathId"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AAPT2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// do something with aapt2")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h2",{attrs:{id:"在代码中执行-aapt2-命令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#在代码中执行-aapt2-命令"}},[t._v("#")]),t._v(" 在代码中执行 "),e("em",[t._v("aapt2")]),t._v(" 命令")]),t._v(" "),e("div",{staticClass:"language-kotlin extra-class"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("runAapt2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("project"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Project"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" aapt2"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" String"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" List"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("String"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" rc "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" project"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("exec")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" spec "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("\n        spec"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isIgnoreExitValue "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n        spec"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("commandLine "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("listOf")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("aapt2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" args\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("when")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rc"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exitValue"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Aapt2 execute successful"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Aapt2 execute failed: '),e("span",{pre:!0,attrs:{class:"token interpolation"}},[e("span",{pre:!0,attrs:{class:"token delimiter variable"}},[t._v("${")]),t._v("rc"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exitValue"),e("span",{pre:!0,attrs:{class:"token delimiter variable"}},[t._v("}")])]),t._v('"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h2",{attrs:{id:"booster-aapt2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#booster-aapt2"}},[t._v("#")]),t._v(" Booster Aapt2")]),t._v(" "),e("p",[t._v("为了便于在 "),e("em",[t._v("Gradle")]),t._v(" 插件中解析 "),e("em",[t._v("flat")]),t._v(" 文件，"),e("em",[t._v("Booster")]),t._v(" 提供了 "),e("a",{attrs:{href:"https://github.com/didi/booster/tree/master/booster-aapt2",target:"_blank",rel:"noopener noreferrer"}},[t._v("booster-aapt2"),e("OutboundLink")],1),t._v(" 模块，提供了 "),e("a",{attrs:{href:"https://github.com/didi/booster/blob/master/booster-aapt2/src/main/kotlin/com/didiglobal/booster/aapt2/BinaryParser.kt",target:"_blank",rel:"noopener noreferrer"}},[t._v("BinaryParser"),e("OutboundLink")],1),t._v(" 以及 "),e("a",{attrs:{href:"https://github.com/didi/booster/blob/master/booster-aapt2/src/main/kotlin/com/didiglobal/booster/aapt2/Aapt2Parser.kt",target:"_blank",rel:"noopener noreferrer"}},[t._v("Aapt2Parser"),e("OutboundLink")],1),t._v(" 来解析已编译的资源，由于 "),e("em",[t._v("Android Gradle Plugin")]),t._v(" 版本间存在差异导致 "),e("em",[t._v("AAPT2")]),t._v(" 中间产物格式不一致，而 "),e("a",{attrs:{href:"https://github.com/didi/booster/tree/master/booster-aapt2",target:"_blank",rel:"noopener noreferrer"}},[t._v("booster-aapt2"),e("OutboundLink")],1),t._v(" 屏蔽了这些细微的差异，以简化已编译资源文件的解析过程。")]),t._v(" "),e("h3",{attrs:{id:"使用方法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用方法"}},[t._v("#")]),t._v(" 使用方法")]),t._v(" "),e("p",[t._v("在 "),e("em",[t._v("build.gradle")]),t._v(" 中引入 "),e("a",{attrs:{href:"https://github.com/didi/booster/tree/master/booster-aapt2",target:"_blank",rel:"noopener noreferrer"}},[t._v("booster-aapt2"),e("OutboundLink")],1),t._v(" 依赖，如下所示：")]),t._v(" "),e("div",{staticClass:"language-groovy extra-class"},[e("pre",{pre:!0,attrs:{class:"language-groovy"}},[e("code",[t._v("buildscript "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    ext "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        kotlin_version "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1.3.31'")]),t._v("\n        booster_version "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3.1.0'")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    repositories "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mavenLocal")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mavenCentral")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("google")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("jcenter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        maven "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" url "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://oss.sonatype.org/content/repositories/public/'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        maven "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" url "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://oss.sonatype.org/content/repositories/snapshots/'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    dependencies "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        classpath "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'com.android.tools.build:gradle:3.5.0'")]),t._v("\n        classpath "),e("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"org.jetbrains.kotlin:kotlin-gradle-plugin:'),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),t._v("kotlin_version")]),t._v('"')]),t._v("\n\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 👇👇👇👇 引用这个模块 👇👇👇👇 */")]),t._v("\n        classpath "),e("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"com.didiglobal.booster:booster-aapt2:'),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),t._v("booster_version")]),t._v('"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("然后，通过 "),e("a",{attrs:{href:"https://github.com/didi/booster/blob/master/booster-aapt2/src/main/kotlin/com/didiglobal/booster/aapt2/BinaryParser.kt",target:"_blank",rel:"noopener noreferrer"}},[t._v("BinaryParser"),e("OutboundLink")],1),t._v(" 和 "),e("a",{attrs:{href:"https://github.com/didi/booster/blob/master/booster-aapt2/src/main/kotlin/com/didiglobal/booster/aapt2/Aapt2Parser.kt",target:"_blank",rel:"noopener noreferrer"}},[t._v("Aapt2Parser"),e("OutboundLink")],1),t._v(" 来解析已编译的资源文件：")]),t._v(" "),e("div",{staticClass:"language-kotlin extra-class"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("parseCompiledResource")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("res"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" File"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" container "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("BinaryParser")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("res"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" parser "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("\n        parser"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("parseAapt2Container")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    container"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("entries"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        it "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Aapt2Container"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ResFile\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" res "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// do something with parsed resource")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])])}),[],!1,null,null,null);a.default=r.exports}}]);