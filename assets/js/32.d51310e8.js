(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{330:function(t,s,a){"use strict";a.r(s);var n=a(33),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"release-构建依赖检查"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#release-构建依赖检查"}},[t._v("#")]),t._v(" Release 构建依赖检查")]),t._v(" "),a("p",[a("em",[t._v("APP")]),t._v(" 在日常的版本发布中，难免因为某些原因要回滚版本，尽管发布之前会在 "),a("em",[t._v("Git")]),t._v(" 上打 "),a("em",[t._v("Tag")]),t._v("，回滚到原来的 "),a("em",[t._v("Tag")]),t._v(" ，即使在同一台机器上，也未必能构建出跟原来一模一样的 "),a("em",[t._v("APK")]),t._v("，其中，影响回滚的很重要的一个原因是依赖的版本管理。为什么依赖的版本管理如此重要呢？这得从一个故事说起。")]),t._v(" "),a("blockquote",[a("p",[t._v("某 "),a("em",[t._v("APP")]),t._v(" 在上一个版本 "),a("em",[t._v("v1.2.0")]),t._v(" 中依赖了 "),a("em",[t._v("libsecurity")]),t._v(" 库，版本号为 "),a("em",[t._v("1.0.0-SNAPSHOT")]),t._v("，接下来，"),a("em",[t._v("APP")]),t._v(" 要发布 "),a("em",[t._v("v1.3.0")]),t._v("，在这个版本中，依赖了 "),a("em",[t._v("libsecurity")]),t._v(" 库的 "),a("em",[t._v("1.0.1-SNAPSHOT")]),t._v(" 版本，经过灰度发布后，未见明显异常，于是开始全量发布，结果，在放量的过程中，发现有个新增的崩溃陡增，经排查发现，是由于 "),a("em",[t._v("libsecurity")]),t._v(" 库中的动态库导致，因此不得不将 "),a("em",[t._v("libsecurity")]),t._v(" 库的版本回滚到上一个版本 —— "),a("em",[t._v("1.0.0-SNAPSHOT")]),t._v("，回滚后灰度依然未发现问题，接着开始全量，在全量的过程，又发现了跟之前一样的崩溃。")])]),t._v(" "),a("p",[t._v("故事到这儿，可能有人就会问了，上一个版本不是没问题么？为什么回滚版本了，在新版本中出现的崩溃为什么会出现在旧版本中？")]),t._v(" "),a("p",[t._v("经过排查发现，原来是 "),a("em",[t._v("libsecurity")]),t._v(" 库的维护者将 "),a("em",[t._v("1.0.1-SNAPSHOT")]),t._v(" 中的 "),a("em",[t._v("feature")]),t._v(" 以 "),a("em",[t._v("1.0.0-SNAPSHOT")]),t._v(" 的版本号发布到了 "),a("em",[t._v("Maven")]),t._v(" 仓库中，导致原来的 "),a("em",[t._v("1.0.0-SNAPSHOT")]),t._v(" 混入了新的代码，所以，即使回滚到了原来的版本，问题依然还存在。")]),t._v(" "),a("h2",{attrs:{id:"解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[t._v("#")]),t._v(" 解决方案")]),t._v(" "),a("p",[t._v("但平常的开发迭代中，如果 "),a("em",[t._v("Code Review")]),t._v(" 不够仔细，就容易出现上面的情况，将 "),a("em",[t._v("SNAPSHOT")]),t._v(" 版本带到线上，为了方便的解决这一问题，"),a("em",[t._v("Booster")]),t._v(" 提供了 "),a("a",{attrs:{href:"https://github.com/didi/booster/blob/master/booster-task-check-snapshot",target:"_blank",rel:"noopener noreferrer"}},[t._v("booster-task-check-snapshot"),a("OutboundLink")],1),t._v(" 模块，用于对 "),a("em",[t._v("Release")]),t._v(" 构建的依赖库版本进行检查，避免依赖 "),a("em",[t._v("SNAPSHOT")]),t._v(" 版本的库：")]),t._v(" "),a("div",{staticClass:"language-kotlin extra-class"},[a("pre",{pre:!0,attrs:{class:"language-kotlin"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("internal")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("open")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" CheckSnapshot "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("DefaultTask")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("lateinit")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" variant"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" BaseVariant\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@TaskAction")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("variant"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("buildType"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isDebuggable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            variant"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dependencies"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("filter")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                it"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("componentIdentifier "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" MavenUniqueSnapshotComponentIdentifier\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                it"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("componentIdentifier "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" MavenUniqueSnapshotComponentIdentifier\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ifNotEmpty")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" snapshots "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token interpolation variable"}},[t._v("$CSI_YELLOW")]),t._v(" ⚠️  "),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token delimiter variable"}},[t._v("${")]),t._v("snapshots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size"),a("span",{pre:!0,attrs:{class:"token delimiter variable"}},[t._v("}")])]),t._v(" SNAPSHOT artifacts found in "),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token delimiter variable"}},[t._v("${")]),t._v("variant"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token delimiter variable"}},[t._v("}")])]),t._v(" variant:"),a("span",{pre:!0,attrs:{class:"token interpolation variable"}},[t._v("$CSI_RESET")]),t._v('\\n${snapshots.joinToString("')]),t._v("\\n"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('") { snapshot -> "')]),t._v("$CSI_YELLOW→  $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("snapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("displayName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("$CSI_RESET"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('" }}"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"如何使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何使用"}},[t._v("#")]),t._v(" 如何使用")]),t._v(" "),a("p",[t._v("启用 "),a("em",[t._v("SNAPSHOT")]),t._v(" 检查只需要在根工程的 "),a("em",[t._v("build.gradle")]),t._v(" 中引入 "),a("a",{attrs:{href:"https://github.com/didi/booster/blob/master/booster-task-check-snapshot",target:"_blank",rel:"noopener noreferrer"}},[t._v("booster-task-check-snapshot"),a("OutboundLink")],1),t._v(" 模块，如下所示：")]),t._v(" "),a("div",{staticClass:"language-groovy extra-class"},[a("pre",{pre:!0,attrs:{class:"language-groovy"}},[a("code",[t._v("buildscript "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    ext "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        kotlin_version "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1.3.31'")]),t._v("\n        booster_version "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3.1.0'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    repositories "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mavenLocal")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mavenCentral")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("google")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("jcenter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        maven "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" url "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://oss.sonatype.org/content/repositories/public/'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        maven "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" url "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://oss.sonatype.org/content/repositories/snapshots/'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    dependencies "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        classpath "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'com.android.tools.build:gradle:3.5.0'")]),t._v("\n        classpath "),a("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"org.jetbrains.kotlin:kotlin-gradle-plugin:'),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),t._v("kotlin_version")]),t._v('"')]),t._v("\n        classpath "),a("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"com.didiglobal.booster:booster-gradle-plugin:'),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),t._v("booster_version")]),t._v('"')]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 👇👇👇👇 引用这个模块 👇👇👇👇 */")]),t._v("\n        classpath "),a("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"com.didiglobal.booster:booster-task-check-snapshot:'),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),t._v("booster_version")]),t._v('"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("然后，在命令行中执行 "),a("code",[t._v("checkSnapshot")]),t._v(" 任务：")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ ./gradlew checkSnapshot\n")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);