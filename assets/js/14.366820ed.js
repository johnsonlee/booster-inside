(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{328:function(t,s,a){"use strict";a.r(s);var n=a(33),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"选择字节码操作框架"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#选择字节码操作框架"}},[t._v("#")]),t._v(" 选择字节码操作框架")]),t._v(" "),a("h2",{attrs:{id:"asm-vs-javassist"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#asm-vs-javassist"}},[t._v("#")]),t._v(" ASM vs Javassist")]),t._v(" "),a("p",[t._v("很多开发者在选择字节码操作框架之初，都会有所疑惑，到底是选择 "),a("em",[t._v("Javassist")]),t._v(" 呢？还是 "),a("em",[t._v("ASM")]),t._v(" 呢？我们可能从以下几个方面来对比一下两者之间的差异，以及适用范围：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("特性")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("Javassist")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("ASM")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("包大小")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("771 KB (3.27)")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("265 KB (6.0 BETA)")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("性能")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("劣于 "),a("em",[t._v("ASM")])]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("优于 "),a("em",[t._v("Javassist")])])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("API 封装程度")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("高")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("低")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("功能完备程度")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("完备")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("完备")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("对开发者的要求")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("基本了解 "),a("em",[t._v("class")]),t._v(" 文件格式和 "),a("em",[t._v("JVM")]),t._v(" 指令集")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("需要精通 "),a("em",[t._v("class")]),t._v(" 文件格式和 "),a("em",[t._v("JVM")]),t._v(" 指令集")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("学习曲线")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("平缓")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("陡峭")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("文档及手册")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("简单明了")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("有些繁琐（Vistor 模式让初学者有点懵）")])])])]),t._v(" "),a("p",[t._v("从上面的对比来看，我想各位读者已经有所选择，对我个人而言，如果是初学者，建议选择 "),a("em",[t._v("Javassist")]),t._v("，毕竟上手快，学习起来比较容易，如果是对性能、包体积方面要求比较高，建议选择 "),a("em",[t._v("ASM")]),t._v("。")]),t._v(" "),a("p",[t._v("所以，为了照顾到尽可能多的开发者，"),a("em",[t._v("Booster")]),t._v(" 对两者都做了支持，看过 "),a("em",[t._v("Booster")]),t._v(" 的源码的同学可能会问，为什么 "),a("em",[t._v("Booster")]),t._v(" 的大部分实现都是基于 "),a("em",[t._v("ASM")]),t._v(" 呢？究竟有哪些考量？")]),t._v(" "),a("h2",{attrs:{id:"asm-javassist-性能测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#asm-javassist-性能测试"}},[t._v("#")]),t._v(" ASM & Javassist 性能测试")]),t._v(" "),a("p",[a("em",[t._v("Booster")]),t._v(" 最初在选择字节码操作框架的时候，最主要的考量因素是性能，"),a("em",[t._v("Booster")]),t._v(" 作为质量优化框架，不仅自身模块在性能上要求做到极致，也要让其他开发者基于 "),a("em",[t._v("Booster")]),t._v(" 开发的功能在性能上也要表现卓越，所以，针对 "),a("em",[t._v("Javassist")]),t._v(" 和 "),a("em",[t._v("ASM")]),t._v(" 在字节码处理方面的性能作了 "),a("em",[t._v("benchmark")]),t._v(" 测试，以下是通过处理 "),a("em",[t._v("guava-28.2-jre.jar")]),t._v(" 来对比二者之间的性能：")]),t._v(" "),a("div",{staticClass:"language-kotlin extra-class"},[a("pre",{pre:!0,attrs:{class:"language-kotlin"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@BenchmarkMode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Mode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AverageTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@OutputTimeUnit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("TimeUnit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MILLISECONDS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@Fork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" jvmArgs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-Xms2G"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-Xmx2G"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@State")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Scope"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Benchmark"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("open")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" JavassistVsAsmBenchmark "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("lateinit")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" file"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" File\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@Setup")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("file "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" File"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createTempFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"guava-"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-28.2-jre.jar"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        javaClass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("classLoader"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getResourceAsStream")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"guava-28.2-jre.jar"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" input "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("\n            file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("outputStream")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" output "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("\n                input"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!!")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("copyTo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("output"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@Benchmark")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("transformJarUsingAsm")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("TransformHelper")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" AndroidSdk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getAndroidJar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("parentFile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("transform")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("transformers "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("arrayOf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("AsmTransformer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("AsmThreadTransformer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@Benchmark")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("transformJarUsingJavassist")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("TransformHelper")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" AndroidSdk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getAndroidJar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("parentFile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("transform")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("transformers "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("arrayOf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("JavassistTransformer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("JavassistThreadTransformer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@TearDown")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("teardown")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("delete")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("blockquote",[a("p",[a("em",[t._v("Benchmark")]),t._v(" 测试代码：https://github.com/johnsonlee/booster-benchmark")])]),t._v(" "),a("p",[a("em",[t._v("Benchmark")]),t._v(" 测试结果如下：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("Benchmark")]),t._v(" "),a("th",[t._v("Mode")]),t._v(" "),a("th",[t._v("Cnt")]),t._v(" "),a("th",[t._v("Score")]),t._v(" "),a("th",[t._v("Error")]),t._v(" "),a("th",[t._v("Units")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("JavassistVsAsmBenchmark.transformJarUsingAsm")]),t._v(" "),a("td",[t._v("avgt")]),t._v(" "),a("td",[t._v("10")]),t._v(" "),a("td",[t._v("203.489")]),t._v(" "),a("td",[t._v("± 52.174")]),t._v(" "),a("td",[t._v("ms/op")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("JavassistVsAsmBenchmark.transformJarUsingJavassist")]),t._v(" "),a("td",[t._v("avgt")]),t._v(" "),a("td",[t._v("10")]),t._v(" "),a("td",[t._v("277.695")]),t._v(" "),a("td",[t._v("± 10.801")]),t._v(" "),a("td",[t._v("ms/op")])])])]),t._v(" "),a("p",[t._v("从上面的结果来看，"),a("em",[t._v("ASM")]),t._v(" 平均耗时更低")]),t._v(" "),a("h2",{attrs:{id:"其它选择"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其它选择"}},[t._v("#")]),t._v(" 其它选择")]),t._v(" "),a("p",[t._v("除了 "),a("em",[t._v("ASM")]),t._v(" 和 "),a("em",[t._v("Javassist")]),t._v(" 以外，"),a("em",[t._v("Booster")]),t._v(" 同样支持使用其它的字节码框架，比如："),a("a",{attrs:{href:"https://commons.apache.org/bcel/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Apache Commons BCEL"),a("OutboundLink")],1),t._v("，只不过，"),a("em",[t._v("ASM")]),t._v(" 和 "),a("em",[t._v("Javassist")]),t._v(" 是 "),a("em",[t._v("Booster")]),t._v(" 默认提供了支持，如果要在项目中使用 "),a("a",{attrs:{href:"https://commons.apache.org/bcel/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Apache Commons BCEL"),a("OutboundLink")],1),t._v(" —— 请参阅"),a("RouterLink",{attrs:{to:"/developer/bytecode-transformer.html#自定义-transformer"}},[t._v("字节码操作 - 自定义 Transformer")]),t._v("。")],1)])}),[],!1,null,null,null);s.default=e.exports}}]);