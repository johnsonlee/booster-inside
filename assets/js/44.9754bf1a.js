(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{363:function(t,s,e){"use strict";e.r(s);var a=e(33),n=Object(a.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"zip-文件压缩"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#zip-文件压缩"}},[t._v("#")]),t._v(" ZIP 文件压缩")]),t._v(" "),e("h2",{attrs:{id:"ap-文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ap-文件"}},[t._v("#")]),t._v(" AP_ 文件")]),t._v(" "),e("p",[t._v("在 "),e("em",[t._v("Android")]),t._v(" 的构建流程中，真正将 "),e("em",[t._v("dex")]),t._v(", "),e("em",[t._v("resources")]),t._v(", "),e("em",[t._v("assets")]),t._v(", "),e("em",[t._v("so")]),t._v(" 等文件合并成 "),e("em",[t._v("APK")]),t._v(" 的工作是在 "),e("em",[t._v("package Task")]),t._v(" 里完的，而在 "),e("em",[t._v("APK")]),t._v(" 生成之前，其实已经有了原型—— "),e("em",[t._v("AP_")]),t._v(" 文件，也就是 "),e("em",[t._v("processRes Task")]),t._v(" 的产物，里面的内容包括：")]),t._v(" "),e("ol",[e("li",[e("code",[t._v("AndroidManifest.xml")])]),t._v(" "),e("li",[e("code",[t._v("res/*")])]),t._v(" "),e("li",[e("code",[t._v("resources.arsc")])])]),t._v(" "),e("p",[t._v("其中 "),e("code",[t._v("res/*")]),t._v(" 是合并后的所有资源，"),e("code",[t._v("resources.arsc")]),t._v(" 则是 "),e("code",[t._v("res/*")]),t._v(" 的索引表（详见："),e("RouterLink",{attrs:{to:"/feature/agp/resource-table.html"}},[t._v("Resource Table 概述")]),t._v("），通过 "),e("code",[t._v("file")]),t._v(" 命令查看一下文件格式：")],1),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" ./build/intermediates/processed_res/debug/out/resources-debug.ap_\n")])])]),e("p",[t._v("得到如下输出结果：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("./build/intermediates/processed_res/debug/out/resources-debug.ap_: Zip archive data\n")])])]),e("p",[t._v("原来 "),e("em",[t._v("AP_")]),t._v(" 文件就是一个普通的 "),e("em",[t._v("ZIP")]),t._v(" 文件，通过 "),e("code",[t._v("unzip")]),t._v(" 命令查看该文件内容：")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("unzip")]),t._v(" -lv ./build/intermediates/processed_res/debug/out/resources-debug.ap_\n")])])]),e("p",[t._v("得到如下输出结果：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("Archive:  ./build/intermediates/processed_res/debug/out/resources-debug.ap_\n Length   Method    Size  Cmpr    Date    Time   CRC-32   Name\n--------  ------  ------- ---- ---------- ----- --------  ----\n    2240  Defl:N      816  64% 01-01-1980 08:00 ad4de798  AndroidManifest.xml\n     388  Defl:N      217  44% 01-01-1980 08:00 1d501a5f  res/anim/abc_fade_in.xml\n     388  Defl:N      218  44% 01-01-1980 08:00 0bab7627  res/anim/abc_fade_out.xml\n     852  Defl:N      376  56% 01-01-1980 08:00 6225a06b  res/anim/abc_grow_fade_in_from_bottom.xml\n     508  Defl:N      258  49% 01-01-1980 08:00 41a0b5fb  res/anim/abc_popup_enter.xml\n     508  Defl:N      260  49% 01-01-1980 08:00 aa2f234a  res/anim/abc_popup_exit.xml\n     852  Defl:N      376  56% 01-01-1980 08:00 687167d1  res/anim/abc_shrink_fade_out_from_bottom.xml\n     396  Defl:N      228  42% 01-01-1980 08:00 505f4409  res/anim/abc_slide_in_bottom.xml\n     396  Defl:N      229  42% 01-01-1980 08:00 62c18818  res/anim/abc_slide_in_top.xml\n     396  Defl:N      227  43% 01-01-1980 08:00 7280bebd  res/anim/abc_slide_out_bottom.xml\n     396  Defl:N      228  42% 01-01-1980 08:00 6c5848d3  res/anim/abc_slide_out_top.xml\n     388  Defl:N      217  44% 01-01-1980 08:00 a5fe5082  res/anim/abc_tooltip_enter.xml\n     388  Defl:N      217  44% 01-01-1980 08:00 82fd0cc5  res/anim/abc_tooltip_exit.xml\n\n     ......\n\n    2060  Stored     2060   0% 01-01-1980 08:00 1d1cb314  res/mipmap-mdpi-v4/ic_launcher.png\n    2783  Stored     2783   0% 01-01-1980 08:00 c64dbd08  res/mipmap-mdpi-v4/ic_launcher_round.png\n    2963  Stored     2963   0% 01-01-1980 08:00 78bc849d  res/mipmap-hdpi-v4/ic_launcher.png\n    4905  Stored     4905   0% 01-01-1980 08:00 ac8a9f01  res/mipmap-hdpi-v4/ic_launcher_round.png\n    4490  Stored     4490   0% 01-01-1980 08:00 bd833a1f  res/mipmap-xhdpi-v4/ic_launcher.png\n    6895  Stored     6895   0% 01-01-1980 08:00 56433f6e  res/mipmap-xhdpi-v4/ic_launcher_round.png\n    6387  Stored     6387   0% 01-01-1980 08:00 ef9c5596  res/mipmap-xxhdpi-v4/ic_launcher.png\n   10413  Stored    10413   0% 01-01-1980 08:00 32b2e261  res/mipmap-xxhdpi-v4/ic_launcher_round.png\n    9128  Stored     9128   0% 01-01-1980 08:00 84b40e39  res/mipmap-xxxhdpi-v4/ic_launcher.png\n   15132  Stored    15132   0% 01-01-1980 08:00 d8318666  res/mipmap-xxxhdpi-v4/ic_launcher_round.png\n     448  Defl:N      222  50% 01-01-1980 08:00 f568abe3  res/mipmap-anydpi-v26/ic_launcher.xml\n     448  Defl:N      222  50% 01-01-1980 08:00 f568abe3  res/mipmap-anydpi-v26/ic_launcher_round.xml\n  260132  Stored   260132   0% 01-01-1980 08:00 ab649898  resources.arsc\n--------          -------  ---                            -------\n  609517           510626  16%                            440 files\n")])])]),e("p",[t._v("其中，第 2 列 "),e("em",[t._v("Method")]),t._v(" 就是存入 "),e("em",[t._v("ZIP")]),t._v(" 文件中采用的压缩方法，参考 "),e("em",[t._v("JDK References")]),t._v(" 中 "),e("a",{attrs:{href:"https://docs.oracle.com/javase/8/docs/api/java/util/zip/ZipEntry.html#setMethod-int-",target:"_blank",rel:"noopener noreferrer"}},[t._v("ZipEntry.setMethod(int)"),e("OutboundLink")],1),t._v("：")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}},[t._v("setMethod")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("public void setMethod(int method)")]),e("br"),e("br"),t._v("Sets the compression method for the entry."),e("br"),e("br"),e("strong",[t._v("Parameters:")]),t._v(" "),e("br"),e("em",[t._v("method - the compression method, either "),e("code",[t._v("STORED")]),t._v(" or "),e("code",[t._v("DEFLATED")])]),e("br"),t._v(" "),e("strong",[t._v("Throws:")]),e("br"),t._v(" "),e("em",[t._v("IllegalArgumentException - if the specified compression method is invalid")]),e("br")])])])]),t._v(" "),e("p",[t._v("关于 "),e("code",[t._v("STORED")]),t._v(" 和 "),e("code",[t._v("DEFLATED")]),t._v(" 的定义：")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}},[t._v("STORED")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("public static final int STORED")]),t._v(" "),e("br"),e("br"),t._v("Compression method for uncompressed entries.")])])])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}},[t._v("DEFLATED")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("public static final int DEFLATED")]),t._v(" "),e("br"),e("br"),t._v("Compression method for compressed (deflated) entries.")])])])]),t._v(" "),e("p",[t._v("所以，采用 "),e("em",[t._v("ZIP")]),t._v(" 打包的文件不一定都是压缩过的，也有未压缩的，这也很容易理解，像图片、音频、视频文件，已经编码压缩过，再用 "),e("em",[t._v("ZIP")]),t._v(" 压缩也根本压缩不了多少，有的可能压缩后比原来还要大，所以，这又为我们做包体积瘦身打开了另一扇大门。")]),t._v(" "),e("h2",{attrs:{id:"解决思路"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#解决思路"}},[t._v("#")]),t._v(" 解决思路")]),t._v(" "),e("p",[t._v("既然 "),e("em",[t._v("AP_")]),t._v(" 文件是 "),e("em",[t._v("processRes Task")]),t._v(" 的产物，那我们直接在 "),e("em",[t._v("processRes Task")]),t._v(" 任务完成之后对 "),e("em",[t._v("AP_")]),t._v(" 文件进行重新压缩，逻辑简单明了：")]),t._v(" "),e("div",{staticClass:"language-kotlin extra-class"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@AutoService")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("VariantProcessor"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" ProcessedResourcesCompressionVariantProcessor "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" VariantProcessor "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("override")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("process")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("variant"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" BaseVariant"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" results "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("CompressionResults")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        variant"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("processResTask"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("doLast")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            variant"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("compressProcessedRes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("results"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            variant"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("generateReport")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("results"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h2",{attrs:{id:"如何使用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#如何使用"}},[t._v("#")]),t._v(" 如何使用")]),t._v(" "),e("p",[t._v("开启 "),e("em",[t._v("ZIP")]),t._v(" 压缩只需要引入 "),e("a",{attrs:{href:"https://github.com/didi/booster/blob/master/booster-task-compression-processed-res",target:"_blank",rel:"noopener noreferrer"}},[t._v("booster-task-compression-processed-res"),e("OutboundLink")],1),t._v(" 即可，如下所示：")]),t._v(" "),e("div",{staticClass:"language-groovy extra-class"},[e("pre",{pre:!0,attrs:{class:"language-groovy"}},[e("code",[t._v("buildscript "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    ext "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        kotlin_version "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1.3.31'")]),t._v("\n        booster_version "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3.1.0'")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    repositories "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mavenLocal")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mavenCentral")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("google")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("jcenter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        maven "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" url "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://oss.sonatype.org/content/repositories/public/'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        maven "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" url "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://oss.sonatype.org/content/repositories/snapshots/'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    dependencies "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        classpath "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'com.android.tools.build:gradle:3.5.0'")]),t._v("\n        classpath "),e("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"org.jetbrains.kotlin:kotlin-gradle-plugin:'),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),t._v("kotlin_version")]),t._v('"')]),t._v("\n        classpath "),e("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"com.didiglobal.booster:booster-gradle-plugin:'),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),t._v("booster_version")]),t._v('"')]),t._v("\n\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 👇👇👇👇 引用这个模块 👇👇👇👇 */")]),t._v("\n        classpath "),e("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"com.didiglobal.booster:booster-task-compression-processed-res:'),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),t._v("booster_version")]),t._v('"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h2",{attrs:{id:"_7-zip-压缩"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-zip-压缩"}},[t._v("#")]),t._v(" "),e("em",[t._v("7-zip")]),t._v(" 压缩")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://www.7-zip.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("7-zip"),e("OutboundLink")],1),t._v(" 与 "),e("em",[t._v("ZIP")]),t._v(" 压缩的原理相同，只不过 "),e("em",[t._v("7-zip")]),t._v(" 采用了压缩率更高的 "),e("em",[t._v("LZMA")]),t._v(" 和 "),e("em",[t._v("LZMA2")]),t._v(" 算法，瘦身效果更佳，推荐使用 "),e("a",{attrs:{href:"https://github.com/shwenzhang/AndResGuard",target:"_blank",rel:"noopener noreferrer"}},[t._v("AndResguard"),e("OutboundLink")],1),t._v("，虽然 "),e("em",[t._v("7-zip")]),t._v(" 的压缩效果非常显著，但是会存在一些副作用，可能会导致 "),e("em",[t._v("Google Play")]),t._v(" 的优化算法失效。")]),t._v(" "),e("h2",{attrs:{id:"到底要不要压缩-arsc-和-so-？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#到底要不要压缩-arsc-和-so-？"}},[t._v("#")]),t._v(" 到底要不要压缩 "),e("em",[t._v("arsc")]),t._v(" 和 "),e("em",[t._v("so")]),t._v(" ？")]),t._v(" "),e("p",[t._v("从技术角度来说，"),e("em",[t._v("Google")]),t._v(" 官方并不推荐对 "),e("em",[t._v("resources.arsc")]),t._v(" 和 "),e("em",[t._v("so")]),t._v(" 进行压缩，这样会导致它们不能被直接 "),e("em",[t._v("mmap")]),t._v(" 到内存，但如果从业务角度来看，如果 "),e("em",[t._v("APK")]),t._v(" 的大小成为了阻碍用户增长的一个因素，而通过压缩 "),e("em",[t._v("resources.arsc")]),t._v(" 和 "),e("em",[t._v("so")]),t._v(" 对用户增长有显著的正向收益，何尝不可呢？")])])}),[],!1,null,null,null);s.default=n.exports}}]);