(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{348:function(t,a,e){"use strict";e.r(a);var s=e(33),n=Object(s.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"资源索引内联"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#资源索引内联"}},[t._v("#")]),t._v(" 资源索引内联")]),t._v(" "),e("h2",{attrs:{id:"资源索引的问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#资源索引的问题"}},[t._v("#")]),t._v(" 资源索引的问题")]),t._v(" "),e("p",[e("em",[t._v("Android")]),t._v(" 在构建的过程中，会为每个模块（库、应用）生成一份资源索引，诸如："),e("em",[t._v("R$id.class")]),t._v("，"),e("em",[t._v("R$layout.class")]),t._v(" 等等，这对于开发者来说，在代码里引用资源十分的方便。")]),t._v(" "),e("p",[t._v("对于 "),e("em",[t._v("library")]),t._v(" 模块来说，"),e("em",[t._v("R")]),t._v(" 文件中的索引值并非常量值，以至于 "),e("em",[t._v("library")]),t._v(" 的类中引用 "),e("em",[t._v("R")]),t._v(" 索引值的方式其实是调用 "),e("em",[t._v("R")]),t._v(" 类的 "),e("em",[t._v("field")]),t._v(" 来实现的，这也是为什么在 "),e("em",[t._v("library")]),t._v(" 工程中不能在 "),e("em",[t._v("switch-case")]),t._v(" 语句或者 "),e("em",[t._v("Annotatio")]),t._v(" 中使用资源索引的原因。以至于 "),e("em",[t._v("ButterKnife")]),t._v(" 创造了独有的 "),e("em",[t._v("R2")]),t._v(" 来解决这个问题。")]),t._v(" "),e("p",[e("em",[t._v("Android")]),t._v(" 系统中定义了 "),e("em",[t._v("10")]),t._v(" 多种资源类型，假设每个模块使用了 "),e("em",[t._v("5")]),t._v(" 种资源类型，就会生成 "),e("em",[t._v("6")]),t._v(" 个对应的 "),e("em",[t._v("class")]),t._v(" 文件（包括 "),e("em",[t._v("R.class")]),t._v("），由于工程结构的复杂度普遍上升，在 "),e("em",[t._v("APP")]),t._v(" 工程中直接或间接引用的 "),e("em",[t._v("library")]),t._v(" 少则几十，多则上百，假设 "),e("em",[t._v("APP")]),t._v(" 中引用了 "),e("em",[t._v("100")]),t._v(" 个 "),e("em",[t._v("library")]),t._v("，那对应的 "),e("em",[t._v("R")]),t._v(" 文件至少是 "),e("em",[t._v("500")]),t._v(" 个以上，无论是类数量、字段数量都是巨大的浪费，毕竟单个 "),e("em",[t._v("dex")]),t._v(" 有 "),e("em",[t._v("65535")]),t._v(" 的限制，虽然有 "),e("em",[t._v("multi-dex")]),t._v(" 技术，但多一个 "),e("em",[t._v("dex")]),t._v(" 就会为安装、冷启动增加不必要的性能开销。")]),t._v(" "),e("h2",{attrs:{id:"删除不必要的-r"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#删除不必要的-r"}},[t._v("#")]),t._v(" 删除不必要的 R")]),t._v(" "),e("p",[t._v("对于 "),e("em",[t._v("Android")]),t._v(" 工程来说，通常，"),e("em",[t._v("library")]),t._v(" 的 "),e("em",[t._v("R")]),t._v(" 只是 "),e("em",[t._v("application")]),t._v(" 的 "),e("em",[t._v("R")]),t._v(" 的一个子集，所以，只要有了全集，子集是可以通通删掉的，而且，"),e("em",[t._v("application")]),t._v(" 的 "),e("em",[t._v("R")]),t._v(" 中的常量字段，一旦参与编译后，就再也没有利用价值（反射除外）。在 "),e("em",[t._v("R")]),t._v(" 的字段，"),e("em",[t._v("styleable")]),t._v(" 字段是一个例外，它不是常量，它是 "),e("code",[t._v("int[]")]),t._v("。所以，删除 "),e("em",[t._v("R")]),t._v(" 之前，我们要弄清楚要确定哪些是能删的，哪些是不能删的，根据经验来看，不能删的索引有：")]),t._v(" "),e("ol",[e("li",[e("p",[e("em",[t._v("ConstraintLayout")]),t._v(" 中引用的字段，例如：")]),t._v(" "),e("div",{staticClass:"language-xml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-xml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("android.support.constraint.Group")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[e("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("android:")]),t._v("id")]),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("@+id/group"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[e("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("android:")]),t._v("layout_width")]),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("wrap_content"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[e("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("android:")]),t._v("layout_height")]),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("wrap_content"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[e("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("android:")]),t._v("visibility")]),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("visible"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[e("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("app:")]),t._v("constraint_referenced_ids")]),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("button4,button9"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n")])])]),e("p",[t._v("其中，"),e("code",[t._v("R.id.button4")]),t._v(" 和 "),e("code",[t._v("R.id.button9")]),t._v(" 是必须要保留的，因为 "),e("em",[t._v("ContraintLayout")]),t._v(" 会调用 "),e("a",{attrs:{href:"https://developer.android.com/reference/android/content/res/TypedArray#getResourceId(int,%20int)"}},[t._v("TypedArray.getResourceId(int, int)")]),t._v(" 来获取 "),e("code",[t._v("button4")]),t._v(" 和 "),e("code",[t._v("button9")]),t._v(" 的 "),e("em",[t._v("id")]),t._v(" 索引。")]),t._v(" "),e("p",[t._v("总结下来，在 "),e("em",[t._v("ConstraintLayout")]),t._v(" 中引用其它 "),e("em",[t._v("id")]),t._v(" 的属性如下：")]),t._v(" "),e("ul",[e("li",[e("code",[t._v("constraint_referenced_ids")])]),t._v(" "),e("li",[e("code",[t._v("layout_constraintLeft_toLeftOf")])]),t._v(" "),e("li",[e("code",[t._v("layout_constraintLeft_toRightOf")])]),t._v(" "),e("li",[e("code",[t._v("layout_constraintRight_toLeftOf")])]),t._v(" "),e("li",[e("code",[t._v("layout_constraintRight_toRightOf")])]),t._v(" "),e("li",[e("code",[t._v("layout_constraintTop_toTopOf")])]),t._v(" "),e("li",[e("code",[t._v("layout_constraintTop_toBottomOf")])]),t._v(" "),e("li",[e("code",[t._v("layout_constraintBottom_toTopOf")])]),t._v(" "),e("li",[e("code",[t._v("layout_constraintBottom_toBottomOf")])]),t._v(" "),e("li",[e("code",[t._v("layout_constraintBaseline_toBaselineOf")])]),t._v(" "),e("li",[e("code",[t._v("layout_constraintStart_toEndOf")])]),t._v(" "),e("li",[e("code",[t._v("layout_constraintStart_toStartOf")])]),t._v(" "),e("li",[e("code",[t._v("layout_constraintEnd_toStartOf")])]),t._v(" "),e("li",[e("code",[t._v("layout_constraintEnd_toEndOf")]),t._v("\n因此，"),e("em",[t._v("Booster")]),t._v(" 采用了解析 "),e("em",[t._v("xml")]),t._v(" 的方式，从 "),e("em",[t._v("xml")]),t._v(" 中提取以上属性。")])])]),t._v(" "),e("li",[e("p",[t._v("其它通过 "),e("a",{attrs:{href:"https://developer.android.com/reference/android/content/res/TypedArray#getResourceId(int,%20int)"}},[t._v("TypedArray.getResourceId(int, int)")]),t._v(" 或 "),e("a",{attrs:{href:"https://developer.android.com/reference/android/content/res/Resources#getIdentifier(java.lang.String,%20java.lang.String,%20java.lang.String)"}},[t._v("Resources.getIdentifier(String, String, String)")]),t._v(" 来获取索引值的资源")]),t._v(" "),e("p",[t._v("针对这种情况，需要对字节码进行全盘扫描才能确定哪些地方调用了 "),e("a",{attrs:{href:"https://developer.android.com/reference/android/content/res/TypedArray#getResourceId(int,%20int)"}},[t._v("TypedArray.getResourceId(int, int)")]),t._v(" 或 "),e("a",{attrs:{href:"https://developer.android.com/reference/android/content/res/Resources#getIdentifier(java.lang.String,%20java.lang.String,%20java.lang.String)"}},[t._v("Resources.getIdentifier(String, String, String)")]),t._v("，考虑到增加一次 "),e("em",[t._v("Transform")]),t._v(" 带来的性能损耗，"),e("em",[t._v("Booster")]),t._v(" 提供了通过配置白名单的方式来保留这些资源索引。")])])]),t._v(" "),e("h2",{attrs:{id:"删除不必要的-field"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#删除不必要的-field"}},[t._v("#")]),t._v(" 删除不必要的 "),e("em",[t._v("Field")])]),t._v(" "),e("p",[t._v("由于 "),e("em",[t._v("Android")]),t._v(" 的资源索引只有 "),e("em",[t._v("32")]),t._v(" 位整型，格式为："),e("code",[t._v("PP")]),t._v(" "),e("code",[t._v("TT")]),t._v(" "),e("code",[t._v("NNNN")]),t._v("，其中：")]),t._v(" "),e("ul",[e("li",[e("code",[t._v("PP")]),t._v(" 为 "),e("em",[t._v("Package ID")]),t._v("，默认为 "),e("code",[t._v("0x7f")]),t._v("；")]),t._v(" "),e("li",[e("code",[t._v("TT")]),t._v(" 为 "),e("em",[t._v("Resource Type ID")]),t._v("，从 "),e("code",[t._v("1")]),t._v(" 开始依次递增；")]),t._v(" "),e("li",[e("code",[t._v("NNNN")]),t._v(" 为 "),e("em",[t._v("Name ID")]),t._v("，从 "),e("code",[t._v("1")]),t._v(" 开始依次递增；")])]),t._v(" "),e("p",[t._v("为了节省空间，在构建 "),e("em",[t._v("application")]),t._v(" 时，所有同类型的资源索引会重排，所以，"),e("em",[t._v("library")]),t._v(" 工程在构建期间无法确定资源最终的索引值，这就是为什么 "),e("em",[t._v("library")]),t._v(" 工程中的资源索引是变量而非常量，既然在 "),e("em",[t._v("application")]),t._v(" 工程中可以确定每个资源最终的索引值了，为什么不将 "),e("em",[t._v("library")]),t._v(" 中的资源索引也替换为常量呢？这样就可以删掉多余的 "),e("em",[t._v("field")]),t._v(" 了，在一定程度上可以减少 "),e("em",[t._v("dex")]),t._v(" 的数量，收益是相当的可观。")]),t._v(" "),e("p",[t._v("在编译期间获取索引常量值有很多种方法：")]),t._v(" "),e("ol",[e("li",[t._v("反射 "),e("em",[t._v("R")]),t._v(" 类文件")]),t._v(" "),e("li",[t._v("解析 "),e("em",[t._v("R")]),t._v(" 类文件")]),t._v(" "),e("li",[t._v("解析 "),e("em",[t._v("Symbol List (R.txt)")])])]),t._v(" "),e("p",[t._v("经过 "),e("em",[t._v("benchmark")]),t._v(" 测试发现，解析 "),e("em",[t._v("Symbol List")]),t._v(" 的方案性能最优，因此，在 "),e("em",[t._v("Transform")]),t._v(" 之前拿到所有资源名称与索引值的映射关系，然后在 "),e("em",[t._v("Transform")]),t._v(" 的过程中将 "),e("RouterLink",{attrs:{to:"/feature/jvm/instructions.html#getfield"}},[t._v("getfield")]),t._v(" 指令替换成 "),e("RouterLink",{attrs:{to:"/feature/jvm/instructions.html#ldc"}},[t._v("ldc")]),t._v(" 指令即可。")],1),t._v(" "),e("h2",{attrs:{id:"如何使用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#如何使用"}},[t._v("#")]),t._v(" 如何使用")]),t._v(" "),e("p",[t._v("开启资源索引内联只需要引入 "),e("a",{attrs:{href:"https://github.com/didi/booster/blob/master/booster-transform-r-inline",target:"_blank",rel:"noopener noreferrer"}},[t._v("booster-transform-r-inline"),e("OutboundLink")],1),t._v(" 即可，如下所示：")]),t._v(" "),e("div",{staticClass:"language-groovy extra-class"},[e("pre",{pre:!0,attrs:{class:"language-groovy"}},[e("code",[t._v("buildscript "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    ext "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        kotlin_version "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1.3.31'")]),t._v("\n        booster_version "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3.1.0'")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    repositories "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mavenLocal")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mavenCentral")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("google")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("jcenter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        maven "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" url "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://oss.sonatype.org/content/repositories/public/'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        maven "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" url "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://oss.sonatype.org/content/repositories/snapshots/'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    dependencies "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        classpath "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'com.android.tools.build:gradle:3.5.0'")]),t._v("\n        classpath "),e("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"org.jetbrains.kotlin:kotlin-gradle-plugin:'),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),t._v("kotlin_version")]),t._v('"')]),t._v("\n        classpath "),e("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"com.didiglobal.booster:booster-gradle-plugin:'),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),t._v("booster_version")]),t._v('"')]),t._v("\n\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 👇👇👇👇 引用这个模块 👇👇👇👇 */")]),t._v("\n        classpath "),e("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"com.didiglobal.booster:booster-transform-r-inline:'),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),t._v("booster_version")]),t._v('"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h2",{attrs:{id:"忽略特定的资源"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#忽略特定的资源"}},[t._v("#")]),t._v(" 忽略特定的资源")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/didi/booster/blob/master/booster-transform-r-inline",target:"_blank",rel:"noopener noreferrer"}},[t._v("booster-transform-r-inline"),e("OutboundLink")],1),t._v(" 支持通过属性的方式来忽略指定的资源。")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}},[t._v("属性")]),t._v(" "),e("th",[t._v("说明")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("booster.transform.r.inline.ignores")])]),t._v(" "),e("td",[t._v("忽略的资源限定符（逗号分隔，支持通配符）")])])])]),t._v(" "),e("h3",{attrs:{id:"通过-gradle-properties-配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#通过-gradle-properties-配置"}},[t._v("#")]),t._v(" 通过 "),e("em",[t._v("gradle.properties")]),t._v(" 配置")]),t._v(" "),e("div",{staticClass:"language-properties extra-class"},[e("pre",{pre:!0,attrs:{class:"language-properties"}},[e("code",[e("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("booster.transform.r.inline.ignores")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("android/*,androidx/*")]),t._v("\n")])])]),e("h3",{attrs:{id:"通过命令行配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#通过命令行配置"}},[t._v("#")]),t._v(" 通过命令行配置")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ ./gradlew assembleDebug -Pbooster.transform.r.inline.ignores"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("android/*,androidx/*\n")])])])])}),[],!1,null,null,null);a.default=n.exports}}]);